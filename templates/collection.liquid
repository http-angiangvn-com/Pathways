{%- assign check_filer = false -%}
{%- if settings.collection_filter_show -%}
{%- assign check_filter = true -%}
{%- endif -%}
{%- assign checkFilter = false -%}
{%- if settings.collection_filter_show -%} 
{%- assign checkFilter = true -%} 
{%- endif -%}

<div class="layout-collections">
	{%- paginate collection.products by settings.collection_pagination_limit -%}
	{%- include 'breadcrumb' -%}
  <div class=" banner-collection-header text-center">
    {% if collection.image.src != blank %}
    <img src="{{ collection.image.src }}" alt="{{collection.title}}"/>
    {% else %}
    {% if settings.show_collection_image%}
    <img src="{{ 'collection_banner.jpg' | asset_url }}" alt="{{collection.title}}"/>
    {% endif %}
    {% endif %}
  </div>
	<div class="wrapper-mainCollection">
		<div class="collection-listproduct" id="collection-body">
			<div class="wrapper-collection-hrvpmo hrvpmo-grids">	
				<div class="container">
					<div class="hrv-pmo-coupon" data-hrvpmo-layout="grids"></div>
					<div class="hrv-pmo-discount" data-hrvpmo-layout="grids"></div>
				</div>
			</div>
			<div class="collection-content">
				<div class="collection-heading">
					<div class="collection-heading__content">
						{%- if settings.collection_filter_show or settings.collection_sortby -%}
						<div class="line-collection-content">
							<div class="container">	
								<div class="collection-filter-tags">
								<div class="heading-box">
                  <h1>{%if collection.handle == 'all'%}Tất cả sản phẩm{%else%}{{collection.title}}{%endif%}</h1>
									<div class="filter-box noBorder">							
										<span class="title-count"><b>
											{{collection.all_products_count}}
											</b> sản phẩm
										</span>
									</div>
								</div>
								<div class="line-collection-content">
									<div class="dFlex-row">
                    <div class="heading-box d-block d-md-none">
  										<div class="filter-box">							
  											{%- if settings.collection_filter_show -%}
  											<p class="title-filter">
  												<span>{{settings.collection_filter_title}}</span>
  												<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path d="m16 133.612h260.513c7.186 29.034 33.45 50.627 64.673 50.627s57.487-21.593 64.673-50.627h90.141c8.836 0 16-7.164 16-16s-7.164-16-16-16h-90.142c-7.185-29.034-33.449-50.628-64.673-50.628s-57.488 21.594-64.673 50.628h-260.512c-8.836 0-16 7.164-16 16s7.164 16 16 16zm325.186-50.628c19.094 0 34.628 15.534 34.628 34.627 0 19.094-15.534 34.628-34.628 34.628s-34.628-15.534-34.628-34.628c0-19.093 15.534-34.627 34.628-34.627zm-325.186 189.016h90.142c7.186 29.034 33.449 50.627 64.673 50.627s57.487-21.593 64.673-50.627h260.512c8.836 0 16-7.164 16-16s-7.164-16-16-16h-260.513c-7.186-29.034-33.449-50.628-64.673-50.628s-57.487 21.594-64.673 50.628h-90.141c-8.836 0-16 7.164-16 16s7.163 16 16 16zm154.814-50.628c19.094 0 34.628 15.534 34.628 34.628 0 19.093-15.534 34.627-34.628 34.627s-34.628-15.534-34.628-34.627c0-19.094 15.534-34.628 34.628-34.628zm325.186 157.016h-90.142c-7.186-29.034-33.449-50.628-64.673-50.628s-57.487 21.594-64.673 50.628h-260.512c-8.836 0-16 7.164-16 16s7.164 16 16 16h260.513c7.186 29.034 33.449 50.628 64.673 50.628s57.487-21.594 64.673-50.628h90.141c8.836 0 16-7.164 16-16s-7.163-16-16-16zm-154.814 50.628c-19.094 0-34.628-15.534-34.628-34.628s15.534-34.628 34.628-34.628 34.628 15.534 34.628 34.628-15.534 34.628-34.628 34.628z" fill="#000000" data-original="#000000" class=""></path></g></svg>
  											</p>
  											{%- endif -%}
  										</div>
                    </div>
    								<div class="heading-sortbyfilter">
  										<div class="collection-sortbyfilter-container">
  											<div class="collection-sortby-filter">
  												{%- if settings.collection_sortby and collection.products_count > 0 -%}
  												<div class="collection-sortby">
  													<div class="layered_filter_title boxstyle-mb" data-layered-click="#layered_sortby_mobile">
  														<p class="title_filter">
  															<span class="icon-filter"><i class="fa fa-sort-alpha-asc" aria-hidden="true"></i></span>
  															<span class="icon-close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></span>										
  															{{settings.collection_sortby_title}}
  														</p>
  													</div>
  												</div>
  												{%- endif -%}
  											</div>
  											<div class="collection-sortby-option layered_filter_mobileContent" id="layered_sortby_mobile" >
  												<ul class="sort-by sort-by-content">
  													{% unless collection.handle == 'all' %}	<li><span data-value="manual" data-filter="">Sản phẩm nổi bật</span></li>{% endunless %}
  													<li><span data-value="price-ascending" data-filter="(price:product=asc)">Giá: Tăng dần</span></li>
  													<li><span data-value="price-descending" data-filter="(price:product=desc)">Giá: Giảm dần</span></li>
  													<li><span data-value="title-ascending" data-filter="(title:product=asc)">Tên: A-Z</span></li>
  													<li><span data-value="title-descending" data-filter="(title:product=desc)">Tên: Z-A</span></li>
  													<li><span data-value="created-ascending" data-filter="(updated_at:product=asc)">Cũ nhất</span></li>
  													<li><span data-value="created-descending" data-filter="(updated_at:product=desc)">Mới nhất</span></li>
  													<li><span data-value="best-selling" data-filter="(sold_quantity:product=desc)">Bán chạy nhất</span></li>
  													<li><span data-value="quantity-descending" data-filter="(quantity:product=desc)">Tồn kho giảm dần</span></li>
  												</ul>
  											</div>
  										</div>
  									</div>
                  </div>
                </div>
								</div>
							</div>
						</div>
						{%- endif -%}
					</div>
				</div>
				<div class="container container-pd-parent">	
					<div class="collection-wraper">
						<div class="wraplist-collection">
							<div class="row"> 
								{% if settings.collection_filter_show %}
                <div class="col-md-3 col-sm-12 col-xs-12 sidebar-fix">
									<div class="wrap-filter">
										{%- include 'collection-filter' -%}
									</div>
								</div>
								{% endif %}
                <div class="{% if settings.collection_filter_show %}col-md-9{% else %}col-md-12{% endif %} col-xs-12">
									<div class="listProduct-row listProduct-filter">
										{%- if collection.products.size == 0 -%}
										<div class="col-md-12 product-noloop">
											<div class="collection-alert-no"><p>Chưa có sản phẩm nào trong danh mục này</p></div>
										</div>
										{%- else -%}
										{%- for product in collection.products limit: settings.collection_pagination_limit -%}
										{%- include 'product-loop' with collection.handle, section:'collection' -%}
										{%- endfor -%}	
										{%- endif -%}	
									</div>
									<div class="clearfix"></div>
									{%- if collection.products.size > 0 -%}	
									<div class="collection-loadmore text-center">
										{%- if paginate.pages > 1 and paginate.pages > paginate.current_page  -%}	
										<a class="button btn-loadmore" data-page="{{paginate.current_page | plus: 1 }}" data-collectionid="{{ collection.id }}" data-collectionhd="{{ collection.url }}" href="javascript:void(0);">Xem thêm sản phẩm</a>
										{%- endif -%}	
									</div>
									{%- endif -%}	
							</div>
						</div>
					</div>
				</div>
			</div>
			</div>
		</div>
	</div>
	{%- endpaginate -%}
	<input type="text" class="d-none" id="coll-handle" value="{% if collection.handle == 'all' %}(collectionid:product>0){% else %}(collectionid:product={{collection.id}}){% endif %}" />
</div>
<script>
	var hasChangeSort = false;
	var activeFilter = {{settings.collection_filter_show}};
	var activeSort = {{settings.collection_sortby}};
	function sortby() {
		var parent = this;
		var collectionsort = "{{ collection.sort_by | default: collection.default_sort_by  }}";
		Haravan.queryParams = {};
		if (location.search.length) {
			for (var aKeyValue, i = 0, aCouples = location.search.substr(1).split('&'); i < aCouples.length; i++) {
				aKeyValue = aCouples[i].split('=');
				if (aKeyValue.length > 1) {
					Haravan.queryParams[decodeURIComponent(aKeyValue[0])] = decodeURIComponent(aKeyValue[1]);
				}
			}
		}
		jQuery('.sort-by li').each(function(){
			if($(this).find('span').data('value') == collectionsort){
				$(this).addClass('active');
			}
		});
	}
	function closeFilterMobile() {
		$('.collection-filter').find('.layered_filter_parent').removeClass('show-filter');	
		setTimeout(function(){ 
			$('.collection-filter').find('.layered_filter_parent').fadeOut();	
			$(".layered_filter_parent .overlays-rgba").remove(); 
		}, 100);
	}
</script>
<script>
	var query = "", total_page = 0, total_product = 0, cur_page = 1, str = "", sortByPicked = '';	
	jQuery(document).ready(function(){
		sortby();
		function formatDate(date) {
			var d = new Date(date),
					month = '' + (d.getMonth() + 1),
					day = '' + d.getDate(),
					year = d.getFullYear();

			if (month.length < 2) 
				month = '0' + month;
			if (day.length < 2) 
				day = '0' + day;

			return [day, month, year].join('-');
		}
		function dateRange(startDate, endDate, steps = 1) {
			const dateArray = [];
			let currentDate = new Date(startDate);

			while (currentDate <= new Date(endDate)) {
				dateArray.push(formatDate(new Date(currentDate)));
				// Use UTC date to prevent problems with time zones and DST
				currentDate.setUTCDate(currentDate.getUTCDate() + steps);
			}

			return dateArray;
		}
		jQuery('.sort-by li').click(function(){
			hasChangeSort = true;
			if($(this).hasClass('active')){}
			else{
				var defaultSort = $(this).find('span').data('value');
				$('.sort-by li').removeClass('active');
				$('.checkbox-sortby li').removeClass('active');
				$(this).addClass('active');
				$('.checkbox-sortby li span[data-value="'+ defaultSort +'"]').parent().addClass('active');
				Stringfilter();			
			}
		})
    $('.tour-search-field-inner select').change(function(){
        Stringfilter();	
    })
		jQuery('.checkbox-sortby li').click(function(){
			if($(this).hasClass('active')){}
			else{
				$('.checkbox-sortby li').removeClass('active');
				$(this).addClass('active');	
			}
		})
    $('.t-datepicker').tDatePicker({
      // Options
			formatDate      : 'DD/MM/YY',
      }).on('afterCheckOut',function(e, dataDate){
      setTimeout(function(){
        Stringfilter();
      }, 1000)
    })
    $('.remove-attr svg').click(function(){
      if($(this).closest('.tour-search-field').hasClass('destination'))
        $('.tour-search-field-inner select option[value="none"]').prop("selected", true);
      else
        $('.t-datepicker').tDatePicker({})
      Stringfilter();
    })
		jQuery('.checkbox-list li > input').click(function(){
			jQuery(this).parent().toggleClass('active');	
			Stringfilter();	
			var indexTitle = jQuery(this).parents('.filter_group').index();
			if (jQuery(this).parents('.filter_group').find('li.active').length > 0 ){
				var textFilter = [];
				jQuery(this).parents('.filter_group').find('li.active').each(function(){
					var textVal = $(this).find('label').html();
					textFilter.push(textVal);
				});
				//console.log(textFilter)
				$('.filter_tags:eq('+indexTitle+') b').html(textFilter.join(',')).parent().addClass('opened');
				if ($('.filter_tags:not(.filter_tags_remove_all).opened').length > 1 ){
					$('.filter_tags_remove_all').addClass('opened');
				}
			}
			else{
				$('.filter_tags:eq('+indexTitle+') b').html('').parent().removeClass('opened');
				$('.filter_tags_remove_all').removeClass('opened');
			}

			if($('.checkbox-list li.active').length == 0){
				$('.btn-collection.btn_clear_filter').hide();
			} else {
				$('.btn-collection.btn_clear_filter').show();
			}
			//console.log($('.checkbox-list li.active').length)
		});	
		jQuery('.filter_tags_remove').click(function(){
			$(this).parent().removeClass('opened').find('b').html();
			var indexClick = $(this).parent().index();
			$('.filter_group:eq('+indexClick+') li.active input').prop('checked', false);
			$('.filter_group:eq('+indexClick+') li.active').removeClass('active');
			if($('.filter_tags:not(.filter_tags_remove_all).opened').length == 1){
				$('.filter_tags_remove_all').removeClass('opened');
			}
			if($('.checkbox-list li.active').length == 0){
				LoadOrigin();
				hasChangeSort = false;
			}
			else{
				Stringfilter();
			}
		});
		jQuery('.filter_tags_remove_all').click(function(){
			$('.checkbox-list li.active input').prop('checked', false);
			$('.checkbox-list li.active').removeClass('active');
			$('.filter_tags b').html('').parent().removeClass('opened');
			$('.filter_tags_remove_all').removeClass('opened');
			hasChangeSort = false;
			LoadOrigin();
		});
		jQuery('.btn_clear_filter').on("click",function(){
			$('.checkbox-list li.active input').prop('checked', false);
			$('.checkbox-list li.active').removeClass('active');
			$('.filter_tags b').html('').parent().removeClass('opened');
			$('.filter_tags_remove_all').removeClass('opened');
			$('.btn-collection.btn_clear_filter').hide();
			hasChangeSort = false;
			LoadOrigin();	
		});	
		jQuery('#apply-btn-filter').on("click",function(){	
			if($('.checkbox-list li.active').length == 0){
				var dataSort = $('.checkbox-sortby li.active').find('span').data('value');
				$('.sort-by li span[data-value="'+ dataSort +'"]').trigger('click');
			}else{
				Stringfilter();		
			}
			closeFilterMobile();	
		});
		jQuery('#clear-btn-filter').on("click",function(){
			if($('.checkbox-list li.active').length == 0){
				var originSort = $('.sort-by li.active').find('span').data('value');
				$('.checkbox-sortby li').removeClass('active');
				$('.checkbox-sortby li span[data-value="'+ originSort +'"]').parent().addClass('active');
			}else{
				$('.checkbox-list li.active input').prop('checked', false);
				$('.checkbox-list li.active').removeClass('active');
				$('.filter_tags b').html('').parent().removeClass('opened');
				$('.filter_tags_remove_all').removeClass('opened');
				hasChangeSort = false;
				LoadOrigin();
			}
			closeFilterMobile();	
		});	 
		var Stringfilter = function(){ 
      debugger
			var q="", gia="",vendor="",color="", size="", sortBy = "", tour= "", checkIn ="", checkOut = "", list_tag = "";
			var handle_coll = $('#coll-handle').val();

			var pathName = window.location.pathname;
			if(pathName.indexOf('vendors') > -1 ){
				handle_coll = '(vendor:product contains '+paramUrl.q.replaceAll('-',' ')+')';
				//console.log(handle_coll)
			}
			if(pathName.indexOf('types') > -1 ){
				handle_coll = '(product_type:product='+paramUrl.q.replaceAll('-',' ')+')';
			}
			var str_url = 'filter=';
			q = "("+handle_coll;
        
			jQuery('.filter-price ul.checkbox-list li.active').each(function(){
				gia = gia + jQuery(this).find('input').data('price') + '||';
			})
			gia=gia.substring(0,gia.length -2);
			if(gia != ""){
				gia='('+gia+')';
				q+='&&'+gia;
			}
      if($('.tour-search-field-inner select').val() != 'none'){
        tour = tour + $('.tour-search-field-inner select').val();
  			if(tour != ""){
  				tour='('+tour+')';
  				q+='&&'+tour;
  			}
      }
      checkIn = $('input.t-input-check-in').val().split('/');
      checkOut = $('input.t-input-check-out').val().split('/');
			
      var date_1 = new Date(checkIn[2]+'-'+checkIn[1]+'-'+checkIn[0]);
			var date_2 = new Date(checkOut[2]+'-'+checkOut[1]+'-'+checkOut[0]);
			const dates = dateRange(date_1,date_2);
      if(checkIn != 'null' && checkOut != 'null'){
				//q+='&&'+'((tag:product=tag_date_'+checkIn+')||(tag:product=tag_date_'+checkOut+'))';
				for (var i = 1; i <= dates.length; i++) {
					list_tag = list_tag + '(tag:product = tag_date_'+dates[i]+')||';
				}
				list_tag = list_tag.slice(0, -2);
				q+='&&'+ (list_tag);
      }
      
			jQuery('.filter-brand ul.checkbox-list li.active').each(function(){
				vendor = vendor + jQuery(this).find('input').data('type') + '||';
			})
			vendor=vendor.substring(0,vendor.length -2);
			if(vendor != ""){
				vendor='('+vendor+')';
				q+='&&'+vendor;
			}

			jQuery('.filter-color ul.checkbox-list li.active').each(function(){
				color = color + jQuery(this).find('input').data('color') + '||';
				//size2 = size2 + jQuery(this).data('s') + '--';
			})
			jQuery('.filter-size ul.checkbox-list li.active').each(function(){
				size = size + jQuery(this).find('input').data('size') + '||';
			})
			size=size.substring(0,size.length -2);
			if(size != ""){
				size='('+size+')';
				q+='&&'+size;
			}
			if ($('.sort-by').length > 0) {
				$('.sort-by li').each(function(){
					if($(this).hasClass('active')){
						if ($(this).find('span').data('value') == 'manual') {
							sortBy = '';
						} else {
							sortBy = '&sortby=' + $(this).find('span').data('filter');
						}
					}
				});
				sortByPicked = sortBy;
			}
			//console.log(str_url + q)
			str_url += encodeURIComponent(q) + ")";
			str = str_url;

			jQuery.ajax({ // lấy tổng số trang của kết quả filter
				url: "/search?q="+str_url+"&view=pagesize",	
				async: false,
				success:function(data){
					data = JSON.parse(data);
					total_page = parseInt(data.pages);
					total_product = parseInt(data.products);
				}
			})
			if(cur_page <= total_page){
				jQuery.ajax({
					url : "/search?q="+str_url+"&view=filter"+sortBy,
					success: function(data){
						setTimeout(function(){ 
							$(".product-noloop").remove();
							$(".listProduct-filter").html('');	
							$(".listProduct-filter").html(data);	
							$('.title-count b').html(total_product);
							if(productReviewsApp &&  productReviewsProloop){ ProductReviews.init(); }
							if(promotionApp){	
								if (promotionApp_name == 'app_combo'){
									comboApp.showGiftLabel();				
								}
								else{	
									buyXgetY.showGiftLabel();	
								}
							}	
							if($(window).width() > 1200){
								$('[data-toggle="popover"]').popover({
									container: 'body'
								})
							}
							if(total_page > 1){
								$('.wraplist-collection .collection-loadmore').addClass('loadmore-filter').show();
								$('.wraplist-collection .collection-loadmore a').attr('data-page',cur_page+1);
							}
							else{
							//	$('.wraplist-collection .listProduct-filter').siblings(':not(h3)').hide();
							}	
						},300);
					}
				});
			} else {
				jQuery(".listProduct-filter").html('');	
				jQuery(".listProduct-filter").append('<div class="col-md-12 product-noloop"><div class="collection-alert-no"><p>Không tìm thấy kết quả. Vui lòng thử lại!</p></div></div>');
				jQuery('.wraplist-collection .collection-loadmore').hide();
				jQuery(".title-count b").html("0");
			}
			var x = $('#collection-body').offset().top;
			HRT.All.smoothScroll(x, 500); 
		}
		var LoadOrigin = function(){
			var view = "?view=data", pageView = '?view=pagesize';			
			cur_page = 1;	
			var collectionHd = "{{collection.url}}";				
			var urlQuery = collectionHd+view;

			var pathName = window.location.pathname;
			if(pathName.indexOf('vendors') > -1 || pathName.indexOf('types') > -1){
				collectionHd = pathName + '?q='+paramUrl.q;
				urlQuery = pathName + '?q='+paramUrl.q+view.replace('?','&');
			}

			if ($('.sort-by').length > 0) {
				$('.sort-by li').each(function(){
					if($(this).hasClass('active')){
						if ($(this).find('span').data('value') == 'manual') {
							sortBy = '';
						} else {
							sortBy = '&sort_by=' + $(this).find('span').data('value');
						}
					}
				});
				sortByPicked = sortBy;
			}

			$.ajax({
				url: collectionHd + (collectionHd.indexOf('?') > -1?pageView.replace('?','&'):pageView),	
				type: 'GET',
				async: false,
				success:function(data){					
					data = JSON.parse(data);
					total_page = parseInt(data.pages);
					total_product = parseInt(data.products);
				}
			});

			$.ajax({
				url: urlQuery+'&page='+cur_page+sortByPicked,
				type: 'GET',
				async: false,
				success:function(data){
					$('.wraplist-collection .listProduct-filter').html('');
					if(cur_page >= total_page && total_page > 1){ 
						$('.wraplist-collection .listProduct-filter').siblings(':not(h3)').hide();
					}
					else{
						setTimeout(function(){ 
							$('.wraplist-collection .listProduct-filter').append(data).addClass('loaded');
							$('.title-count b').html(total_product);
							$('.collection-loadmore .btn-loadmore').attr('data-page',cur_page+1);
							$('.collection-loadmore').find('.btn-loadmore').removeClass('btn-loading')
							$('.collection-loadmore').show();
							if(productReviewsApp &&  productReviewsProloop){ ProductReviews.init(); }
							if(promotionApp){	
								if (promotionApp_name == 'app_combo'){
									comboApp.showGiftLabel();				
								}
								else{	
									buyXgetY.showGiftLabel();	
								}
							}	
							if($(window).width() > 1200){
								$('[data-toggle="popover"]').popover({
									container: 'body'
								})
							}
						}, 400);
					}
				}
			});

			var x = $('#collection-body').offset().top;
			HRT.All.smoothScroll(x, 500);
		}
		$(document).on("click","#collection-body .collection-loadmore .btn-loadmore:not(.btn-loading)", function(e){
			e.preventDefault();
			$(this).addClass('btn-loading');
			var btn = $(this);
			var view = "?view=data", pageView = '?view=pagesize';			
			var link = parseInt($(this).attr("data-page"));		
			var collectionHd = "{{collection.url}}";				
			var urlQuery = collectionHd+view;
			var pathName = window.location.pathname;

			if(pathName.indexOf('vendors') > -1 || pathName.indexOf('types') > -1){
				collectionHd = pathName + '?q='+paramUrl.q;
				urlQuery = pathName + '?q='+paramUrl.q+view.replace('?','&');
			}

			if ($('.sort-by').length > 0) {			
				if($('.sort-by li.active').length > 0){	
					if ($('.sort-by li.active').find('span').data('value') == 'manual') {
						sortBy = '';
					} 
					else {
						if((hasChangeSort) || $('.checkbox-list li.active').length > 0){
							sortBy = '&sortby=' + $('.sort-by li.active').find('span').data('filter');
						}
						else{
							sortBy = '&sort_by=' + $('.sort-by li.active').find('span').data('value');
						}
					}
				}
				else{
					sortBy = '';				
				}
				sortByPicked = sortBy;
			}

			if((activeFilter && $('.checkbox-list li.active').length == 0 && hasChangeSort == false) || (!activeFilter && activeSort && hasChangeSort == false)){
				$.ajax({
					url: collectionHd + (collectionHd.indexOf('?') > -1?pageView.replace('?','&'):pageView),	
					type: 'GET',
					async: false,
					success:function(data){				
						data = JSON.parse(data);
						total_page = parseInt(data.pages);
					}
				});		

				$.ajax({
					url: urlQuery+'&page='+link+sortByPicked,					
					type: 'GET',
					async: false,
					success:function(data){
						setTimeout(function(){ 
							$('.wraplist-collection .listProduct-filter').append(data).addClass('loaded');
							$('.collection-loadmore').find('.btn-loadmore').removeClass('btn-loading');
							if(productReviewsApp &&  productReviewsProloop){	ProductReviews.init();	}
							if(promotionApp){	
								if (promotionApp_name == 'app_combo'){
									comboApp.showGiftLabel();				
								}
								else{	
									buyXgetY.showGiftLabel();	
								}
							}	
							if($(window).width() > 1200){
								$('[data-toggle="popover"]').popover({
									container: 'body'
								})
							}

							if(link == 1){
								$('.wraplist-collection .listProduct-filter').html('');
							}
							if(link >= total_page){ 
								$('.wraplist-collection .listProduct-filter').siblings(':not(h3)').hide();
							}
						}, 350);
					}
				});
				$(this).attr('data-page',link+1);
			}
			else{
				jQuery.ajax({
					url : "/search?q="+str+"&view=filter"+sortByPicked+'&page='+link,
					success: function(data){
						jQuery(".product-noloop").remove();					
						setTimeout(function(){ 
							$('.wraplist-collection .listProduct-filter').append(data).addClass('loaded');
							$('.collection-loadmore').find('.btn-loadmore').removeClass('btn-loading');
							if(productReviewsApp &&  productReviewsProloop){ ProductReviews.init(); }
							if(promotionApp){	
								if (promotionApp_name == 'app_combo'){
									comboApp.showGiftLabel();				
								}
								else{	
									buyXgetY.showGiftLabel();	
								}
							}	
							if(link >= total_page && total_page > 1){
								$('.wraplist-collection .listProduct-filter').siblings(':not(h3)').hide();
							}
							else{
								btn.attr('data-page',link+1);
							}
							if($(window).width() > 1200){
								$('[data-toggle="popover"]').popover({
									container: 'body'
								})
							}
						}, 350);
					}
				});
			}
		});
		$(document).on('click', '.heading-box .title-filter', function(e){
			e.preventDefault();
			$(".layered_filter_parent").append('<div class="overlays-rgba"></div>'); 
			$('.collection-filter').find('.layered_filter_parent').fadeIn(100);	
			$('.collection-filter').find('.layered_filter_parent').addClass('show-filter');	
		});	
		$(document).on('click', '.layered_filter_parent .close_filter,.layered_filter_parent .overlays-rgba', function(e){
			e.preventDefault();
			if($('.checkbox-list li.active').length == 0){
				var originSort = $('.sort-by li.active').find('span').data('value');
				$('.checkbox-sortby li').removeClass('active');
				$('.checkbox-sortby li span[data-value="'+ originSort +'"]').parent().addClass('active');
			}
			closeFilterMobile();
		});
    jQuery('.collection-heading__content .heading-box .filter-box:not(.noBorder)').click(function(){
  		$('.sidebar-fix').slideToggle('medium');
  	});  
	});
</script>
